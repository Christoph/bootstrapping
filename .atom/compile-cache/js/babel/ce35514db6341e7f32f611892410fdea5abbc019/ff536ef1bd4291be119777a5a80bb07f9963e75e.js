function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

/** @babel */

var _specHelpers = require('./spec-helpers');

var _specHelpers2 = _interopRequireDefault(_specHelpers);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _libBuilder = require('../lib/builder');

var _libBuilder2 = _interopRequireDefault(_libBuilder);

var _libBuildState = require('../lib/build-state');

var _libBuildState2 = _interopRequireDefault(_libBuildState);

describe('Builder', function () {
  var builder = undefined,
      fixturesPath = undefined,
      filePath = undefined,
      logFilePath = undefined,
      fdbFilePath = undefined,
      state = undefined,
      jobState = undefined;

  beforeEach(function () {
    builder = new _libBuilder2['default']();
    fixturesPath = _specHelpers2['default'].cloneFixtures();
    filePath = _path2['default'].join(fixturesPath, 'file.tex');
    logFilePath = _path2['default'].join(fixturesPath, 'file.log');
    fdbFilePath = _path2['default'].join(fixturesPath, 'file.fdb_latexmk');
    state = new _libBuildState2['default'](filePath);
    state.setOutputDirectory('');
    jobState = state.getJobStates()[0];
  });

  describe('constructPath', function () {
    it('reads `latex.texPath` as configured', function () {
      spyOn(atom.config, 'get').andReturn();
      builder.constructPath();

      expect(atom.config.get).toHaveBeenCalledWith('latex.texPath');
    });

    it('uses platform default when `latex.texPath` is not configured', function () {
      var defaultTexPath = '/foo/bar';
      var expectedPath = [defaultTexPath, process.env.PATH].join(_path2['default'].delimiter);
      atom.config.set('latex.texPath', '');
      spyOn(builder, 'defaultTexPath').andReturn(defaultTexPath);

      var constructedPath = builder.constructPath();
      expect(constructedPath).toBe(expectedPath);
    });

    it('replaces surrounded $PATH with process.env.PATH', function () {
      var texPath = '/foo:$PATH:/bar';
      var expectedPath = texPath.replace('$PATH', process.env.PATH);
      atom.config.set('latex.texPath', texPath);

      var constructedPath = builder.constructPath();
      expect(constructedPath).toBe(expectedPath);
    });

    it('replaces leading $PATH with process.env.PATH', function () {
      var texPath = '$PATH:/bar';
      var expectedPath = texPath.replace('$PATH', process.env.PATH);
      atom.config.set('latex.texPath', texPath);

      var constructedPath = builder.constructPath();
      expect(constructedPath).toBe(expectedPath);
    });

    it('replaces trailing $PATH with process.env.PATH', function () {
      var texPath = '/foo:$PATH';
      var expectedPath = texPath.replace('$PATH', process.env.PATH);
      atom.config.set('latex.texPath', texPath);

      var constructedPath = builder.constructPath();
      expect(constructedPath).toBe(expectedPath);
    });

    it('prepends process.env.PATH with texPath', function () {
      var texPath = '/foo';
      var expectedPath = [texPath, process.env.PATH].join(_path2['default'].delimiter);
      atom.config.set('latex.texPath', texPath);

      var constructedPath = builder.constructPath();
      expect(constructedPath).toBe(expectedPath);
    });
  });

  describe('parseLogFile', function () {
    var logParser = undefined;

    beforeEach(function () {
      logParser = jasmine.createSpyObj('MockLogParser', ['parse']);
      spyOn(builder, 'getLogParser').andReturn(logParser);
    });

    it('resolves the associated log file path by invoking @resolveLogFilePath', function () {
      spyOn(builder, 'resolveLogFilePath').andReturn('foo.log');

      builder.parseLogFile(jobState);
      expect(builder.resolveLogFilePath).toHaveBeenCalledWith(jobState);
    });

    it('does not attempt parse if passed a file path that does not exist', function () {
      state.setFilePath('/foo/bar/quux.tex');
      builder.parseLogFile(jobState);

      expect(logParser.parse).not.toHaveBeenCalled();
    });

    it('attempts to parse the resolved log file', function () {
      builder.parseLogFile(jobState);

      expect(builder.getLogParser).toHaveBeenCalledWith(logFilePath, filePath);
      expect(logParser.parse).toHaveBeenCalled();
    });
  });

  describe('parseFdbFile', function () {
    var fdbParser = undefined;

    beforeEach(function () {
      fdbParser = jasmine.createSpyObj('MockFdbParser', ['parse']);
      spyOn(builder, 'getFdbParser').andReturn(fdbParser);
    });

    it('resolves the associated fdb file path by invoking @resolveFdbFilePath', function () {
      spyOn(builder, 'resolveFdbFilePath').andReturn('foo.fdb_latexmk');

      builder.parseFdbFile(jobState);
      expect(builder.resolveFdbFilePath).toHaveBeenCalledWith(jobState);
    });

    it('does not attempt parse if passed a file path that does not exist', function () {
      state.setFilePath('/foo/bar/quux.tex');
      builder.parseFdbFile(jobState);

      expect(fdbParser.parse).not.toHaveBeenCalled();
    });

    it('attempts to parse the resolved fdb file', function () {
      builder.parseFdbFile(jobState);

      expect(builder.getFdbParser).toHaveBeenCalledWith(fdbFilePath);
      expect(fdbParser.parse).toHaveBeenCalled();
    });
  });

  describe('parseLogAndFdbFiles', function () {
    it('verifies that the correct output file is selected when using various latexmk modes', function () {
      var switches = [{
        name: 'pdf',
        format: 'pdf'
      }, {
        name: 'pdfdvi',
        format: 'pdf'
      }, {
        name: 'pdfps',
        format: 'pdf'
      }, {
        name: 'ps',
        format: 'ps'
      }, {
        name: 'dvi',
        format: 'dvi'
      }];
      state.setOutputDirectory('log-parse');

      for (var _ref2 of switches) {
        var _name = _ref2.name;
        var format = _ref2.format;

        state.setJobNames(['file-' + _name]);
        jobState = state.getJobStates()[0];
        builder.parseLogAndFdbFiles(jobState);
        expect(_path2['default'].basename(jobState.getOutputFilePath())).toBe(jobState.getJobName() + '.' + format, 'Select ' + format + ' file when using -' + _name + ' switch.');
      }
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL2NocmlzLy5hdG9tL3BhY2thZ2VzL2xhdGV4L3NwZWMvYnVpbGRlci1zcGVjLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7MkJBRW9CLGdCQUFnQjs7OztvQkFDbkIsTUFBTTs7OzswQkFDSCxnQkFBZ0I7Ozs7NkJBQ2Isb0JBQW9COzs7O0FBRTNDLFFBQVEsQ0FBQyxTQUFTLEVBQUUsWUFBTTtBQUN4QixNQUFJLE9BQU8sWUFBQTtNQUFFLFlBQVksWUFBQTtNQUFFLFFBQVEsWUFBQTtNQUFFLFdBQVcsWUFBQTtNQUFFLFdBQVcsWUFBQTtNQUFFLEtBQUssWUFBQTtNQUFFLFFBQVEsWUFBQSxDQUFBOztBQUU5RSxZQUFVLENBQUMsWUFBTTtBQUNmLFdBQU8sR0FBRyw2QkFBYSxDQUFBO0FBQ3ZCLGdCQUFZLEdBQUcseUJBQVEsYUFBYSxFQUFFLENBQUE7QUFDdEMsWUFBUSxHQUFHLGtCQUFLLElBQUksQ0FBQyxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUE7QUFDOUMsZUFBVyxHQUFHLGtCQUFLLElBQUksQ0FBQyxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUE7QUFDakQsZUFBVyxHQUFHLGtCQUFLLElBQUksQ0FBQyxZQUFZLEVBQUUsa0JBQWtCLENBQUMsQ0FBQTtBQUN6RCxTQUFLLEdBQUcsK0JBQWUsUUFBUSxDQUFDLENBQUE7QUFDaEMsU0FBSyxDQUFDLGtCQUFrQixDQUFDLEVBQUUsQ0FBQyxDQUFBO0FBQzVCLFlBQVEsR0FBRyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7R0FDbkMsQ0FBQyxDQUFBOztBQUVGLFVBQVEsQ0FBQyxlQUFlLEVBQUUsWUFBTTtBQUM5QixNQUFFLENBQUMscUNBQXFDLEVBQUUsWUFBTTtBQUM5QyxXQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQTtBQUNyQyxhQUFPLENBQUMsYUFBYSxFQUFFLENBQUE7O0FBRXZCLFlB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aWxkZXItc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKiBAYmFiZWwgKi9cblxuaW1wb3J0IGhlbHBlcnMgZnJvbSAnLi9zcGVjLWhlbHBlcnMnXG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJ1xuaW1wb3J0IEJ1aWxkZXIgZnJvbSAnLi4vbGliL2J1aWxkZXInXG5pbXBvcnQgQnVpbGRTdGF0ZSBmcm9tICcuLi9saWIvYnVpbGQtc3RhdGUnXG5cbmRlc2NyaWJlKCdCdWlsZGVyJywgKCkgPT4ge1xuICBsZXQgYnVpbGRlciwgZml4dHVyZXNQYXRoLCBmaWxlUGF0aCwgbG9nRmlsZVBhdGgsIGZkYkZpbGVQYXRoLCBzdGF0ZSwgam9iU3RhdGVcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBidWlsZGVyID0gbmV3IEJ1aWxkZXIoKVxuICAgIGZpeHR1cmVzUGF0aCA9IGhlbHBlcnMuY2xvbmVGaXh0dXJlcygpXG4gICAgZmlsZVBhdGggPSBwYXRoLmpvaW4oZml4dHVyZXNQYXRoLCAnZmlsZS50ZXgnKVxuICAgIGxvZ0ZpbGVQYXRoID0gcGF0aC5qb2luKGZpeHR1cmVzUGF0aCwgJ2ZpbGUubG9nJylcbiAgICBmZGJGaWxlUGF0aCA9IHBhdGguam9pbihmaXh0dXJlc1BhdGgsICdmaWxlLmZkYl9sYXRleG1rJylcbiAgICBzdGF0ZSA9IG5ldyBCdWlsZFN0YXRlKGZpbGVQYXRoKVxuICAgIHN0YXRlLnNldE91dHB1dERpcmVjdG9yeSgnJylcbiAgICBqb2JTdGF0ZSA9IHN0YXRlLmdldEpvYlN0YXRlcygpWzBdXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ2NvbnN0cnVjdFBhdGgnLCAoKSA9PiB7XG4gICAgaXQoJ3JlYWRzIGBsYXRleC50ZXhQYXRoYCBhcyBjb25maWd1cmVkJywgKCkgPT4ge1xuICAgICAgc3B5T24oYXRvbS5jb25maWcsICdnZXQnKS5hbmRSZXR1cm4oKVxuICAgICAgYnVpbGRlci5jb25zdHJ1Y3RQYXRoKClcblxuICAgICAgZXhwZWN0KGF0b20uY29uZmlnLmdldCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ2xhdGV4LnRleFBhdGgnKVxuICAgIH0pXG5cbiAgICBpdCgndXNlcyBwbGF0Zm9ybSBkZWZhdWx0IHdoZW4gYGxhdGV4LnRleFBhdGhgIGlzIG5vdCBjb25maWd1cmVkJywgKCkgPT4ge1xuICAgICAgY29uc3QgZGVmYXVsdFRleFBhdGggPSAnL2Zvby9iYXInXG4gICAgICBjb25zdCBleHBlY3RlZFBhdGggPSBbZGVmYXVsdFRleFBhdGgsIHByb2Nlc3MuZW52LlBBVEhdLmpvaW4ocGF0aC5kZWxpbWl0ZXIpXG4gICAgICBhdG9tLmNvbmZpZy5zZXQoJ2xhdGV4LnRleFBhdGgnLCAnJylcbiAgICAgIHNweU9uKGJ1aWxkZXIsICdkZWZhdWx0VGV4UGF0aCcpLmFuZFJldHVybihkZWZhdWx0VGV4UGF0aClcblxuICAgICAgY29uc3QgY29uc3RydWN0ZWRQYXRoID0gYnVpbGRlci5jb25zdHJ1Y3RQYXRoKClcbiAgICAgIGV4cGVjdChjb25zdHJ1Y3RlZFBhdGgpLnRvQmUoZXhwZWN0ZWRQYXRoKVxuICAgIH0pXG5cbiAgICBpdCgncmVwbGFjZXMgc3Vycm91bmRlZCAkUEFUSCB3aXRoIHByb2Nlc3MuZW52LlBBVEgnLCAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXhQYXRoID0gJy9mb286JFBBVEg6L2JhcidcbiAgICAgIGNvbnN0IGV4cGVjdGVkUGF0aCA9IHRleFBhdGgucmVwbGFjZSgnJFBBVEgnLCBwcm9jZXNzLmVudi5QQVRIKVxuICAgICAgYXRvbS5jb25maWcuc2V0KCdsYXRleC50ZXhQYXRoJywgdGV4UGF0aClcblxuICAgICAgY29uc3QgY29uc3RydWN0ZWRQYXRoID0gYnVpbGRlci5jb25zdHJ1Y3RQYXRoKClcbiAgICAgIGV4cGVjdChjb25zdHJ1Y3RlZFBhdGgpLnRvQmUoZXhwZWN0ZWRQYXRoKVxuICAgIH0pXG5cbiAgICBpdCgncmVwbGFjZXMgbGVhZGluZyAkUEFUSCB3aXRoIHByb2Nlc3MuZW52LlBBVEgnLCAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXhQYXRoID0gJyRQQVRIOi9iYXInXG4gICAgICBjb25zdCBleHBlY3RlZFBhdGggPSB0ZXhQYXRoLnJlcGxhY2UoJyRQQVRIJywgcHJvY2Vzcy5lbnYuUEFUSClcbiAgICAgIGF0b20uY29uZmlnLnNldCgnbGF0ZXgudGV4UGF0aCcsIHRleFBhdGgpXG5cbiAgICAgIGNvbnN0IGNvbnN0cnVjdGVkUGF0aCA9IGJ1aWxkZXIuY29uc3RydWN0UGF0aCgpXG4gICAgICBleHBlY3QoY29uc3RydWN0ZWRQYXRoKS50b0JlKGV4cGVjdGVkUGF0aClcbiAgICB9KVxuXG4gICAgaXQoJ3JlcGxhY2VzIHRyYWlsaW5nICRQQVRIIHdpdGggcHJvY2Vzcy5lbnYuUEFUSCcsICgpID0+IHtcbiAgICAgIGNvbnN0IHRleFBhdGggPSAnL2ZvbzokUEFUSCdcbiAgICAgIGNvbnN0IGV4cGVjdGVkUGF0aCA9IHRleFBhdGgucmVwbGFjZSgnJFBBVEgnLCBwcm9jZXNzLmVudi5QQVRIKVxuICAgICAgYXRvbS5jb25maWcuc2V0KCdsYXRleC50ZXhQYXRoJywgdGV4UGF0aClcblxuICAgICAgY29uc3QgY29uc3RydWN0ZWRQYXRoID0gYnVpbGRlci5jb25zdHJ1Y3RQYXRoKClcbiAgICAgIGV4cGVjdChjb25zdHJ1Y3RlZFBhdGgpLnRvQmUoZXhwZWN0ZWRQYXRoKVxuICAgIH0pXG5cbiAgICBpdCgncHJlcGVuZHMgcHJvY2Vzcy5lbnYuUEFUSCB3aXRoIHRleFBhdGgnLCAoKSA9PiB7XG4gICAgICBjb25zdCB0ZXhQYXRoID0gJy9mb28nXG4gICAgICBjb25zdCBleHBlY3RlZFBhdGggPSBbdGV4UGF0aCwgcHJvY2Vzcy5lbnYuUEFUSF0uam9pbihwYXRoLmRlbGltaXRlcilcbiAgICAgIGF0b20uY29uZmlnLnNldCgnbGF0ZXgudGV4UGF0aCcsIHRleFBhdGgpXG5cbiAgICAgIGNvbnN0IGNvbnN0cnVjdGVkUGF0aCA9IGJ1aWxkZXIuY29uc3RydWN0UGF0aCgpXG4gICAgICBleHBlY3QoY29uc3RydWN0ZWRQYXRoKS50b0JlKGV4cGVjdGVkUGF0aClcbiAgICB9KVxuICB9KVxuXG4gIGRlc2NyaWJlKCdwYXJzZUxvZ0ZpbGUnLCAoKSA9PiB7XG4gICAgbGV0IGxvZ1BhcnNlclxuXG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBsb2dQYXJzZXIgPSBqYXNtaW5lLmNyZWF0ZVNweU9iaignTW9ja0xvZ1BhcnNlcicsIFsncGFyc2UnXSlcbiAgICAgIHNweU9uKGJ1aWxkZXIsICdnZXRMb2dQYXJzZXInKS5hbmRSZXR1cm4obG9nUGFyc2VyKVxuICAgIH0pXG5cbiAgICBpdCgncmVzb2x2ZXMgdGhlIGFzc29jaWF0ZWQgbG9nIGZpbGUgcGF0aCBieSBpbnZva2luZyBAcmVzb2x2ZUxvZ0ZpbGVQYXRoJywgKCkgPT4ge1xuICAgICAgc3B5T24oYnVpbGRlciwgJ3Jlc29sdmVMb2dGaWxlUGF0aCcpLmFuZFJldHVybignZm9vLmxvZycpXG5cbiAgICAgIGJ1aWxkZXIucGFyc2VMb2dGaWxlKGpvYlN0YXRlKVxuICAgICAgZXhwZWN0KGJ1aWxkZXIucmVzb2x2ZUxvZ0ZpbGVQYXRoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChqb2JTdGF0ZSlcbiAgICB9KVxuXG4gICAgaXQoJ2RvZXMgbm90IGF0dGVtcHQgcGFyc2UgaWYgcGFzc2VkIGEgZmlsZSBwYXRoIHRoYXQgZG9lcyBub3QgZXhpc3QnLCAoKSA9PiB7XG4gICAgICBzdGF0ZS5zZXRGaWxlUGF0aCgnL2Zvby9iYXIvcXV1eC50ZXgnKVxuICAgICAgYnVpbGRlci5wYXJzZUxvZ0ZpbGUoam9iU3RhdGUpXG5cbiAgICAgIGV4cGVjdChsb2dQYXJzZXIucGFyc2UpLm5vdC50b0hhdmVCZWVuQ2FsbGVkKClcbiAgICB9KVxuXG4gICAgaXQoJ2F0dGVtcHRzIHRvIHBhcnNlIHRoZSByZXNvbHZlZCBsb2cgZmlsZScsICgpID0+IHtcbiAgICAgIGJ1aWxkZXIucGFyc2VMb2dGaWxlKGpvYlN0YXRlKVxuXG4gICAgICBleHBlY3QoYnVpbGRlci5nZXRMb2dQYXJzZXIpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKGxvZ0ZpbGVQYXRoLCBmaWxlUGF0aClcbiAgICAgIGV4cGVjdChsb2dQYXJzZXIucGFyc2UpLnRvSGF2ZUJlZW5DYWxsZWQoKVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ3BhcnNlRmRiRmlsZScsICgpID0+IHtcbiAgICBsZXQgZmRiUGFyc2VyXG5cbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIGZkYlBhcnNlciA9IGphc21pbmUuY3JlYXRlU3B5T2JqKCdNb2NrRmRiUGFyc2VyJywgWydwYXJzZSddKVxuICAgICAgc3B5T24oYnVpbGRlciwgJ2dldEZkYlBhcnNlcicpLmFuZFJldHVybihmZGJQYXJzZXIpXG4gICAgfSlcblxuICAgIGl0KCdyZXNvbHZlcyB0aGUgYXNzb2NpYXRlZCBmZGIgZmlsZSBwYXRoIGJ5IGludm9raW5nIEByZXNvbHZlRmRiRmlsZVBhdGgnLCAoKSA9PiB7XG4gICAgICBzcHlPbihidWlsZGVyLCAncmVzb2x2ZUZkYkZpbGVQYXRoJykuYW5kUmV0dXJuKCdmb28uZmRiX2xhdGV4bWsnKVxuXG4gICAgICBidWlsZGVyLnBhcnNlRmRiRmlsZShqb2JTdGF0ZSlcbiAgICAgIGV4cGVjdChidWlsZGVyLnJlc29sdmVGZGJGaWxlUGF0aCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoam9iU3RhdGUpXG4gICAgfSlcblxuICAgIGl0KCdkb2VzIG5vdCBhdHRlbXB0IHBhcnNlIGlmIHBhc3NlZCBhIGZpbGUgcGF0aCB0aGF0IGRvZXMgbm90IGV4aXN0JywgKCkgPT4ge1xuICAgICAgc3RhdGUuc2V0RmlsZVBhdGgoJy9mb28vYmFyL3F1dXgudGV4JylcbiAgICAgIGJ1aWxkZXIucGFyc2VGZGJGaWxlKGpvYlN0YXRlKVxuXG4gICAgICBleHBlY3QoZmRiUGFyc2VyLnBhcnNlKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpXG4gICAgfSlcblxuICAgIGl0KCdhdHRlbXB0cyB0byBwYXJzZSB0aGUgcmVzb2x2ZWQgZmRiIGZpbGUnLCAoKSA9PiB7XG4gICAgICBidWlsZGVyLnBhcnNlRmRiRmlsZShqb2JTdGF0ZSlcblxuICAgICAgZXhwZWN0KGJ1aWxkZXIuZ2V0RmRiUGFyc2VyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChmZGJGaWxlUGF0aClcbiAgICAgIGV4cGVjdChmZGJQYXJzZXIucGFyc2UpLnRvSGF2ZUJlZW5DYWxsZWQoKVxuICAgIH0pXG4gIH0pXG5cbiAgZGVzY3JpYmUoJ3BhcnNlTG9nQW5kRmRiRmlsZXMnLCAoKSA9PiB7XG4gICAgaXQoJ3ZlcmlmaWVzIHRoYXQgdGhlIGNvcnJlY3Qgb3V0cHV0IGZpbGUgaXMgc2VsZWN0ZWQgd2hlbiB1c2luZyB2YXJpb3VzIGxhdGV4bWsgbW9kZXMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBzd2l0Y2hlcyA9IFt7XG4gICAgICAgIG5hbWU6ICdwZGYnLFxuICAgICAgICBmb3JtYXQ6ICdwZGYnXG4gICAgICB9LCB7XG4gICAgICAgIG5hbWU6ICdwZGZkdmknLFxuICAgICAgICBmb3JtYXQ6ICdwZGYnXG4gICAgICB9LCB7XG4gICAgICAgIG5hbWU6ICdwZGZwcycsXG4gICAgICAgIGZvcm1hdDogJ3BkZidcbiAgICAgIH0sIHtcbiAgICAgICAgbmFtZTogJ3BzJyxcbiAgICAgICAgZm9ybWF0OiAncHMnXG4gICAgICB9LCB7XG4gICAgICAgIG5hbWU6ICdkdmknLFxuICAgICAgICBmb3JtYXQ6ICdkdmknXG4gICAgICB9XVxuICAgICAgc3RhdGUuc2V0T3V0cHV0RGlyZWN0b3J5KCdsb2ctcGFyc2UnKVxuXG4gICAgICBmb3IgKGNvbnN0IHsgbmFtZSwgZm9ybWF0IH0gb2Ygc3dpdGNoZXMpIHtcbiAgICAgICAgc3RhdGUuc2V0Sm9iTmFtZXMoW2BmaWxlLSR7bmFtZX1gXSlcbiAgICAgICAgam9iU3RhdGUgPSBzdGF0ZS5nZXRKb2JTdGF0ZXMoKVswXVxuICAgICAgICBidWlsZGVyLnBhcnNlTG9nQW5kRmRiRmlsZXMoam9iU3RhdGUpXG4gICAgICAgIGV4cGVjdChwYXRoLmJhc2VuYW1lKGpvYlN0YXRlLmdldE91dHB1dEZpbGVQYXRoKCkpKS50b0JlKGAke2pvYlN0YXRlLmdldEpvYk5hbWUoKX0uJHtmb3JtYXR9YCxcbiAgICAgICAgICBgU2VsZWN0ICR7Zm9ybWF0fSBmaWxlIHdoZW4gdXNpbmcgLSR7bmFtZX0gc3dpdGNoLmApXG4gICAgICB9XG4gICAgfSlcbiAgfSlcbn0pXG4iXX0=